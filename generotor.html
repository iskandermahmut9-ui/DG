<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Carousel Studio Ultimate v4.0 (High-DPI)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- –®—Ä–∏—Ñ—Ç—ã -->
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;700;900&family=Lato:wght@400;700&family=Merriweather:wght@700&family=Montserrat:wght@400;700;900&family=Open+Sans:wght@600&family=Oswald:wght@700&family=Playfair+Display:wght@700&family=Poppins:wght@600&family=Roboto:wght@700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .editor-container { display: grid; grid-template-columns: 280px 1fr 320px; height: calc(100vh - 64px); }
        /* Canvas –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø–æ —Ä–∞–∑–º–µ—Ä—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –Ω–æ –≤–Ω—É—Ç—Ä–∏ –æ–Ω –æ–≥—Ä–æ–º–Ω—ã–π (HD) */
        canvas { 
            background-color: #1e293b; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
            max-height: 85vh; 
            max-width: 100%; 
            object-fit: contain; 
            /* –î–ª—è —á–µ—Ç–∫–æ—Å—Ç–∏ –Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö */
            image-rendering: -webkit-optimize-contrast;
        }
        .slide-card { transition: all 0.2s; border: 2px solid transparent; user-select: none; }
        .slide-card.active { border-color: #ea580c; background-color: #1e293b; }
        .slide-card.dragging { opacity: 0.5; border-style: dashed; border-color: #64748b; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        input[type="range"] { accent-color: #ea580c; }
        .dropdown-menu { display: none; }
        .dropdown-menu.show { display: block; }
        .filter-btn.active { background-color: #ea580c; color: white; border-color: #ea580c; }
        
        /* Sticker Grid */
        .sticker-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; max-height: 200px; overflow-y: auto; padding: 4px; }
        .sticker-item { cursor: pointer; border-radius: 8px; padding: 4px; background: #1e293b; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .sticker-item:hover { background: #334155; transform: scale(1.1); }
        .sticker-item img { width: 100%; height: auto; }

        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 14px; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body class="overflow-hidden">

    <!-- Toast Notification -->
    <div id="toast">–ü—Ä–æ–µ–∫—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!</div>

    <!-- Header -->
    <header class="h-16 bg-slate-900 border-b border-slate-800 px-6 flex justify-between items-center z-50 relative">
        <div class="flex items-center gap-2">
            <button onclick="undo()" class="p-2 hover:bg-slate-800 rounded-full text-slate-400 hover:text-white transition-colors" title="–û—Ç–º–µ–Ω–∏—Ç—å (Ctrl+Z)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 00-9-9 9 9 0 00-6 2.3L3 13"/></svg>
            </button>
            <button onclick="deleteSelected()" class="p-2 hover:bg-orange-900/50 rounded-full text-slate-400 hover:text-orange-500 transition-colors" title="–£–¥–∞–ª–∏—Ç—å (Delete)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            </button>
            
            <div class="h-6 w-px bg-slate-700 mx-2"></div>
            
            <button onclick="saveProjectToStorage()" class="flex items-center gap-2 px-3 py-1.5 bg-slate-800 hover:bg-slate-700 text-slate-200 rounded-lg text-xs font-bold transition-all border border-slate-700">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>

            <h1 class="ml-4 text-lg font-bold tracking-tight uppercase hidden md:block">Carousel <span class="text-orange-500">Pro</span> <span class="text-[9px] text-slate-500 bg-slate-800 px-1 rounded ml-1">HD</span></h1>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="flex bg-slate-800 rounded-lg p-1">
                <button onclick="changeFormat('1:1')" class="px-3 py-1 text-xs font-bold hover:bg-slate-700 rounded transition-colors" id="btn-1-1">1:1</button>
                <button onclick="changeFormat('9:16')" class="px-3 py-1 text-xs font-bold hover:bg-slate-700 rounded transition-colors" id="btn-9-16">9:16</button>
                <button onclick="changeFormat('16:9')" class="px-3 py-1 text-xs font-bold hover:bg-slate-700 rounded transition-colors" id="btn-16-9">16:9</button>
            </div>
            
            <div class="relative">
                <button onclick="toggleDownloadMenu()" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-6 rounded-lg text-sm transition-all flex items-center gap-2">
                    –°–∫–∞—á–∞—Ç—å ‚ñº
                </button>
                <div id="downloadMenu" class="dropdown-menu absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-xl border border-gray-100 z-[100]">
                    <button onclick="downloadCurrent('jpg')" class="block w-full text-left px-4 py-3 hover:bg-gray-100 text-slate-800 text-xs font-bold border-b border-gray-100">–ö–∞—Ä—Ç–∏–Ω–∫–∞ (JPG)</button>
                    <button onclick="downloadCurrent('png')" class="block w-full text-left px-4 py-3 hover:bg-gray-100 text-slate-800 text-xs font-bold border-b border-gray-100">–ö–∞—Ä—Ç–∏–Ω–∫–∞ (PNG)</button>
                    <button onclick="exportVideo('mp4')" class="block w-full text-left px-4 py-3 hover:bg-gray-100 text-slate-800 text-xs font-bold border-b border-gray-100 flex justify-between">–í–∏–¥–µ–æ (MP4) <span>üé•</span></button>
                    <button onclick="exportAllPDF()" class="block w-full text-left px-4 py-3 hover:bg-orange-50 text-orange-600 text-xs font-bold">–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è (PDF)</button>
                </div>
            </div>
        </div>
    </header>

    <div class="editor-container">
        <!-- –°–ª–∞–π–¥—ã (–°–ª–µ–≤–∞) -->
        <aside class="bg-slate-900 border-r border-slate-800 flex flex-col custom-scrollbar overflow-y-auto">
            <div class="p-4">
                <button onclick="addSlide()" class="w-full bg-slate-800 hover:bg-slate-700 py-3 rounded-lg text-xs font-bold uppercase tracking-wider border border-slate-700 transition-all text-orange-500 border-orange-500/20 hover:border-orange-500">+ –ù–æ–≤—ã–π –°–ª–∞–π–¥</button>
            </div>
            <div id="slideList" class="px-4 pb-4 space-y-3"></div>
        </aside>

        <!-- –•–æ–ª—Å—Ç (–¶–µ–Ω—Ç—Ä) -->
        <main class="relative flex items-center justify-center p-8 bg-slate-950 overflow-hidden" id="mainArea">
            <canvas id="mainCanvas"></canvas>
            <div id="recordingIndicator" class="absolute top-4 right-4 bg-orange-600 text-white text-xs px-3 py-1 rounded-full animate-pulse hidden">
                ‚óè –ó–ê–ü–ò–°–¨...
            </div>
            <div class="absolute bottom-4 text-slate-500 text-[10px] font-mono">
                <span class="text-orange-400">Smart Guides</span> ‚Ä¢ Drag & Drop
            </div>
        </main>

        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–°–ø—Ä–∞–≤–∞) -->
        <aside class="bg-slate-900 border-l border-slate-800 flex flex-col overflow-y-auto custom-scrollbar">
            <div class="p-5 space-y-8">
                
                <!-- 1. –§–æ–Ω –∏ –õ–æ–≥–æ -->
                <div class="space-y-3">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest">–ú–µ–¥–∏–∞</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="cursor-pointer bg-slate-800 hover:bg-slate-700 py-2 rounded text-center text-[10px] font-bold border border-slate-700 hover:border-orange-500/50 transition-colors">
                            –§–æ–Ω
                            <input type="file" accept="image/*" class="hidden" onchange="handleBgUpload(event)">
                        </label>
                         <label class="cursor-pointer bg-blue-900/20 hover:bg-blue-900/40 py-2 rounded text-center text-[10px] font-bold border border-blue-800/50 text-blue-400">
                            + –õ–æ–≥–æ—Ç–∏–ø
                            <input type="file" accept="image/*" class="hidden" onchange="handleLogoUpload(event)">
                        </label>
                    </div>

                    <!-- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å —Ä–∞–∑–º–µ—Ä–∞ –æ–±—ä–µ–∫—Ç–∞ (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–¥–µ–ª–µ–Ω–∏–∏) -->
                    <div id="objectControls" class="hidden space-y-2 bg-slate-800 p-3 rounded border border-orange-500/30">
                        <div class="flex justify-between text-[10px] text-orange-400 font-bold">
                            <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—ä–µ–∫—Ç–∞</span>
                            <span id="objectScaleValue">100%</span>
                        </div>
                        <input type="range" id="objectScaleSlider" min="10" max="300" value="100" class="w-full h-1" oninput="updateSelectedObjectScale()">
                        <p class="text-[9px] text-slate-500">–ò–∑–º–µ–Ω—è–µ—Ç —Ä–∞–∑–º–µ—Ä –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–æ—Ç–∏–ø–∞ –∏–ª–∏ —Å—Ç–∏–∫–µ—Ä–∞</p>
                    </div>
                </div>

                <!-- 2. –¢–µ–∫—Å—Ç -->
                <div class="space-y-4 pt-4 border-t border-slate-800">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest">–¢–µ–∫—Å—Ç –∏ –®—Ä–∏—Ñ—Ç—ã</label>
                    
                    <div class="bg-slate-800/50 p-2 rounded border border-slate-700 hover:border-slate-600">
                        <div class="flex justify-between mb-1">
                            <span class="text-[10px] font-bold text-slate-400">–ó–∞–≥–æ–ª–æ–≤–æ–∫</span>
                            <input type="color" id="mainColor" oninput="saveAndRender()" class="w-4 h-4 rounded cursor-pointer bg-transparent border-none">
                        </div>
                        <input type="text" id="textInput" oninput="saveAndRender()" class="w-full bg-slate-800 border border-slate-700 rounded p-1 text-sm font-bold mb-1 focus:border-orange-500 outline-none" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫">
                        <div class="flex gap-1">
                            <select id="fontSelectMain" onchange="saveAndRender()" class="w-2/3 bg-slate-800 border border-slate-700 rounded p-1 text-[10px] focus:border-orange-500 outline-none">
                                <option value="Montserrat">Montserrat</option><option value="Inter">Inter</option><option value="Roboto">Roboto</option><option value="Open Sans">Open Sans</option><option value="Oswald">Oswald</option><option value="Bebas Neue">Bebas Neue</option><option value="Playfair Display">Playfair</option><option value="Merriweather">Merriweather</option><option value="Poppins">Poppins</option><option value="Lato">Lato</option>
                            </select>
                            <input type="range" id="fontSizeSlider" min="20" max="200" value="100" class="w-1/3 h-4" oninput="saveAndRender()">
                        </div>
                    </div>

                    <div class="bg-slate-800/50 p-2 rounded border border-slate-700 hover:border-slate-600">
                        <div class="flex justify-between mb-1">
                            <span class="text-[10px] font-bold text-slate-400">–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫</span>
                            <input type="color" id="subColor" oninput="saveAndRender()" class="w-4 h-4 rounded cursor-pointer bg-transparent border-none">
                        </div>
                        <input type="text" id="subInput" oninput="saveAndRender()" class="w-full bg-slate-800 border border-slate-700 rounded p-1 text-xs mb-1 focus:border-orange-500 outline-none" placeholder="–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫">
                        <div class="flex gap-1">
                            <select id="fontSelectSub" onchange="saveAndRender()" class="w-2/3 bg-slate-800 border border-slate-700 rounded p-1 text-[10px] focus:border-orange-500 outline-none">
                                <option value="Montserrat">Montserrat</option><option value="Inter">Inter</option><option value="Roboto">Roboto</option><option value="Open Sans">Open Sans</option><option value="Oswald">Oswald</option><option value="Bebas Neue">Bebas Neue</option><option value="Playfair Display">Playfair</option><option value="Merriweather">Merriweather</option><option value="Poppins">Poppins</option><option value="Lato">Lato</option>
                            </select>
                            <input type="range" id="subSizeSlider" min="10" max="100" value="40" class="w-1/3 h-4" oninput="saveAndRender()">
                        </div>
                    </div>

                    <div class="bg-slate-800/50 p-2 rounded border border-slate-700 hover:border-slate-600">
                        <div class="flex justify-between mb-1">
                            <span class="text-[10px] font-bold text-slate-400">–û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç</span>
                            <input type="color" id="bodyColor" oninput="saveAndRender()" class="w-4 h-4 rounded cursor-pointer bg-transparent border-none">
                        </div>
                        <textarea id="bodyInput" oninput="saveAndRender()" class="w-full bg-slate-800 border border-slate-700 rounded p-1 text-xs h-12 mb-1 focus:border-orange-500 outline-none" placeholder="–¢–µ–∫—Å—Ç..."></textarea>
                        <div class="flex gap-1">
                            <select id="fontSelectBody" onchange="saveAndRender()" class="w-2/3 bg-slate-800 border border-slate-700 rounded p-1 text-[10px] focus:border-orange-500 outline-none">
                                <option value="Montserrat">Montserrat</option><option value="Inter">Inter</option><option value="Roboto">Roboto</option><option value="Open Sans">Open Sans</option><option value="Oswald">Oswald</option><option value="Bebas Neue">Bebas Neue</option><option value="Playfair Display">Playfair</option><option value="Merriweather">Merriweather</option><option value="Poppins">Poppins</option><option value="Lato">Lato</option>
                            </select>
                            <input type="range" id="bodySizeSlider" min="10" max="80" value="24" class="w-1/3 h-4" oninput="saveAndRender()">
                        </div>
                    </div>
                </div>

                <!-- 3. –ò–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–∞ -->
                <div class="space-y-3 pt-4 border-t border-slate-800">
                    <div class="flex justify-between items-center">
                        <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest">–ò–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–∞</label>
                        <input type="checkbox" id="showChart" onchange="saveAndRender()" class="accent-orange-600">
                    </div>
                    
                    <select id="chartType" onchange="saveAndRender()" class="w-full bg-slate-800 border border-slate-700 rounded p-1 text-xs mb-2 focus:border-orange-500 outline-none">
                        <option value="bar">–°—Ç–æ–ª–±—á–∞—Ç–∞—è</option>
                        <option value="pie">–ö—Ä—É–≥–æ–≤–∞—è</option>
                        <option value="line">–õ–∏–Ω–µ–π–Ω–∞—è</option>
                        <option value="list">–°–ø–∏—Å–æ–∫</option>
                    </select>

                    <input type="text" id="chartLabels" oninput="saveAndRender()" class="w-full bg-slate-800 border border-slate-700 rounded p-2 text-xs focus:border-orange-500 outline-none" placeholder="–ú–µ—Ç–∫–∏ (X)">
                    <input type="text" id="chartData" oninput="saveAndRender()" class="w-full bg-slate-800 border border-slate-700 rounded p-2 text-xs focus:border-orange-500 outline-none" placeholder="–î–∞–Ω–Ω—ã–µ (Y)">
                    
                    <div class="flex items-center justify-between bg-slate-800 p-2 rounded border border-slate-700">
                        <span class="text-xs text-slate-400">–¶–≤–µ—Ç –≥—Ä–∞—Ñ–∏–∫–∞</span>
                        <input type="color" id="chartColor" oninput="saveAndRender()" value="#ea580c" class="w-6 h-6 rounded cursor-pointer bg-transparent border-none">
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] text-slate-400">–ú–∞—Å—à—Ç–∞–±</span>
                        <input type="range" id="chartScale" min="50" max="150" value="100" class="flex-1" oninput="saveAndRender()">
                    </div>
                </div>

                <!-- 4. –†–∞–º–∫–∏ -->
                <div class="space-y-3 pt-4 border-t border-slate-800">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest">–†–∞–º–∫–∏</label>
                    <select id="frameType" onchange="saveAndRender()" class="w-full bg-slate-800 border border-slate-700 rounded p-1 text-xs focus:border-orange-500 outline-none">
                        <option value="none">–ù–µ—Ç</option>
                        <option value="simple">–ü—Ä–æ—Å—Ç–∞—è</option>
                        <option value="offset">–î–≤–æ–π–Ω–∞—è</option>
                        <option value="corners">–£–≥–æ–ª–∫–∏</option>
                        <option value="neon">–ù–µ–æ–Ω</option>
                    </select>
                    <div class="flex gap-2 items-center">
                        <input type="range" id="frameScale" min="80" max="100" value="95" class="flex-1 h-2" oninput="saveAndRender()">
                        <input type="color" id="frameColor" oninput="saveAndRender()" value="#ffffff" class="w-6 h-6 rounded cursor-pointer bg-transparent border-none">
                    </div>
                </div>

                <!-- 5. –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –°—Ç–∏–∫–µ—Ä–æ–≤ -->
                <div class="space-y-3 pt-4 border-t border-slate-800">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –°—Ç–∏–∫–µ—Ä–æ–≤ (PNG)</label>
                    <div class="flex gap-2">
                        <input type="text" id="stickerSearch" class="flex-1 bg-slate-800 border border-slate-700 rounded p-2 text-xs focus:border-orange-500 outline-none" placeholder="–ü–æ–∏—Å–∫ (cat, star, fire)...">
                        <button onclick="searchStickers()" class="bg-orange-600 hover:bg-orange-700 text-white p-2 rounded text-xs font-bold">üîç</button>
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="quickCategory('emoji')" class="text-[10px] bg-slate-800 hover:bg-slate-700 px-2 py-1 rounded text-slate-300">Emoji</button>
                        <button onclick="quickCategory('shape')" class="text-[10px] bg-slate-800 hover:bg-slate-700 px-2 py-1 rounded text-slate-300">–§–∏–≥—É—Ä—ã</button>
                        <button onclick="quickCategory('social')" class="text-[10px] bg-slate-800 hover:bg-slate-700 px-2 py-1 rounded text-slate-300">–°–æ—Ü—Å–µ—Ç–∏</button>
                    </div>
                    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
                    <div id="stickerResults" class="sticker-grid custom-scrollbar bg-slate-900 border border-slate-800 rounded-lg h-40">
                        <div class="col-span-4 text-center text-[10px] text-slate-500 mt-10">–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</div>
                    </div>
                </div>

                <!-- 6. –≠—Ñ—Ñ–µ–∫—Ç—ã -->
                <div class="space-y-2 pt-4 border-t border-slate-800">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest">–§–∏–ª—å—Ç—Ä—ã</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="toggleEffect('grain')" id="eff-grain" class="filter-btn p-1 bg-slate-800 rounded text-[9px] hover:bg-slate-700 border border-transparent">–®—É–º</button>
                        <button onclick="toggleEffect('paper')" id="eff-paper" class="filter-btn p-1 bg-slate-800 rounded text-[9px] hover:bg-slate-700 border border-transparent">–ë—É–º–∞–≥–∞</button>
                        <button onclick="toggleEffect('vignette')" id="eff-vignette" class="filter-btn p-1 bg-slate-800 rounded text-[9px] hover:bg-slate-700 border border-transparent">–í–∏–Ω—å–µ—Ç–∫–∞</button>
                        <button onclick="toggleEffect('grunge')" id="eff-grunge" class="filter-btn p-1 bg-slate-800 rounded text-[9px] hover:bg-slate-700 border border-transparent">–ì—Ä–∞–Ω–∂</button>
                        <button onclick="toggleEffect('retro')" id="eff-retro" class="filter-btn p-1 bg-slate-800 rounded text-[9px] hover:bg-slate-700 border border-transparent">–†–µ—Ç—Ä–æ</button>
                        <button onclick="toggleEffect('contrast')" id="eff-contrast" class="filter-btn p-1 bg-slate-800 rounded text-[9px] hover:bg-slate-700 border border-transparent">–ö–æ–Ω—Ç—Ä–∞—Å—Ç</button>
                    </div>
                </div>

            </div>
        </aside>
    </div>

    <script>
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const apiKey = ""; 

        // --- Config with High-DPI Scale Factor ---
        const SCALE = 2; // 2x resolution multiplier for crisp rendering

        let config = {
            width: 1080, // Logical width
            height: 1080, // Logical height
            slides: [],
            currentIdx: 0,
            drag: { active: false, target: null, offsetX: 0, offsetY: 0, srcIdx: -1 },
            selected: null, 
            effects: { grain: false, paper: false, vignette: false, grunge: false, retro: false, contrast: false },
            frame: { type: 'none', scale: 0.95, color: '#ffffff' },
            history: [],
            historyStep: -1,
            guides: { x: null, y: null },
            isRecording: false
        };

        // --- Init ---
        window.onload = () => {
            if (localStorage.getItem('carousel_project')) {
                loadProjectFromStorage();
            } else {
                addSlide(); 
                changeFormat('1:1');
                saveState(); 
            }
            
            window.addEventListener('keydown', (e) => {
                if(e.key === 'Delete' || e.key === 'Backspace') {
                    if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') deleteSelected();
                }
            });
        };

        function toggleDownloadMenu() { document.getElementById('downloadMenu').classList.toggle('show'); }
        window.onclick = function(e) { if (!e.target.matches('.bg-orange-600')) { var d = document.getElementsByClassName("dropdown-menu"); for (var i=0; i<d.length; i++) if (d[i].classList.contains('show')) d[i].classList.remove('show'); }}

        // --- STORAGE ---
        function saveProjectToStorage() {
            try {
                const serializedSlides = config.slides.map(s => {
                    const obj = { ...s };
                    obj.bgImg = null; 
                    obj.logos = s.logos.map(l => ({...l, img: null, src: l.src})); 
                    obj.stickers = s.stickers.map(st => ({...st, img: null, src: st.src})); 
                    if (s.bgImg) obj.bgSrc = s.bgImg.src;
                    return obj;
                });
                const data = { width: config.width, height: config.height, effects: config.effects, frame: config.frame, slides: serializedSlides };
                localStorage.setItem('carousel_project', JSON.stringify(data));
                showToast("–ü—Ä–æ–µ–∫—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!");
            } catch (e) {
                alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –¥–∞–Ω–Ω—ã—Ö.");
            }
        }

        function loadProjectFromStorage() {
            try {
                const data = JSON.parse(localStorage.getItem('carousel_project'));
                config.width = data.width; config.height = data.height; config.effects = data.effects; config.frame = data.frame || { type: 'none', scale: 0.95, color: '#ffffff' };
                config.slides = data.slides.map(s => {
                    const slide = { ...s };
                    if (slide.logo) {
                        slide.logos = [];
                        if (slide.logo.img || slide.logoSrc) {
                            const l = { ...slide.logo, src: slide.logoSrc };
                            if(slide.logoSrc) { const i = new Image(); i.src=slide.logoSrc; i.onload=()=>draw(); l.img = i; }
                            slide.logos.push(l);
                        }
                        delete slide.logo;
                    }
                    if(!slide.logos) slide.logos = [];

                    if (s.bgSrc) { slide.bgImg = new Image(); slide.bgImg.src = s.bgSrc; slide.bgImg.onload = () => draw(); }
                    
                    if (slide.logos) {
                        slide.logos = slide.logos.map(l => {
                            const newL = { ...l };
                            if(l.src) { newL.img = new Image(); newL.img.src = l.src; newL.img.onload = () => draw(); }
                            return newL;
                        });
                    }

                    if (s.stickers) { slide.stickers = s.stickers.map(st => { const newSt = { ...st }; if(st.src) { newSt.img = new Image(); newSt.img.src = st.src; newSt.img.onload = () => draw(); } return newSt; }); }
                    return slide;
                });
                config.currentIdx = 0;
                changeFormat(config.width === 1920 ? '16:9' : config.width === 1080 && config.height === 1920 ? '9:16' : '1:1');
                updateUIEffects(); renderSlideList(); loadUIFromSlide(); draw();
            } catch (e) { localStorage.removeItem('carousel_project'); addSlide(); }
        }

        function showToast(msg) { const t = document.getElementById("toast"); t.innerText = msg; t.className = "show"; setTimeout(function(){ t.className = t.className.replace("show", ""); }, 3000); }

        // --- History ---
        function saveState() {
            if (config.historyStep < config.history.length - 1) config.history = config.history.slice(0, config.historyStep + 1);
            const state = JSON.stringify(config.slides, (k, v) => (k === 'bgImg' || k === 'img') ? null : v);
            config.history.push({ slides: JSON.parse(state), effects: {...config.effects}, frame: {...config.frame}, idx: config.currentIdx });
            config.historyStep++;
        }
        function undo() {
            if (config.historyStep > 0) {
                config.historyStep--;
                const state = config.history[config.historyStep];
                const currentSlides = config.slides;
                config.slides = state.slides.map((sData, i) => {
                    const existing = currentSlides[i] || {};
                    const n = { ...sData };
                    if(existing.bgImg) n.bgImg = existing.bgImg; else if(sData.bgSrc) { n.bgImg = new Image(); n.bgImg.src = sData.bgSrc; }
                    
                    if(n.logos) n.logos.forEach((l, k) => { if(existing.logos && existing.logos[k]) l.img = existing.logos[k].img; });
                    if(n.stickers) n.stickers.forEach((st, k) => { if(existing.stickers && existing.stickers[k]) st.img = existing.stickers[k].img; });
                    return n;
                });
                config.effects = state.effects; config.frame = state.frame; config.currentIdx = state.idx; config.selected = null; 
                updateUIEffects(); loadUIFromSlide(); renderSlideList(); draw();
            }
        }
        function saveAndRender() { updateSlideData(); }
        
        function updateSelectedObjectScale() {
            const val = document.getElementById('objectScaleSlider').value;
            document.getElementById('objectScaleValue').innerText = val + '%';
            const s = config.slides[config.currentIdx];
            
            if (config.selected && config.selected.startsWith('logo-')) {
                const idx = parseInt(config.selected.split('-')[1]);
                if (s.logos[idx]) s.logos[idx].scale = val / 100;
            } else if (config.selected && config.selected.startsWith('sticker-')) {
                const idx = parseInt(config.selected.split('-')[1]);
                if (s.stickers[idx]) s.stickers[idx].scale = val / 100;
            }
            draw(); saveState();
        }
        
        // --- Core ---
        function createSlide() {
            return {
                bgType: 'color', bgVal: '#1e293b', bgImg: null, bgPos: {x: 0, y: 0},
                text: "–ó–ê–ì–û–õ–û–í–û–ö", fontMain: "Montserrat", colorMain: "#ffffff", fontSize: 100, textPos: { x: config.width/2, y: 300 },
                sub: "–ü–û–î–ó–ê–ì–û–õ–û–í–û–ö", fontSub: "Montserrat", colorSub: "#cbd5e1", subSize: 40, subPos: { x: config.width/2, y: 400 },
                body: "–û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç...", fontBody: "Open Sans", colorBody: "#cbd5e1", bodySize: 24, bodyPos: { x: config.width/2, y: 500 },
                logos: [], 
                chart: { visible: false, type: 'bar', labels: "A, B, C, D", data: "40, 70, 50, 90", colors: "#ea580c", scale: 1, pos: { x: config.width/2, y: config.height - 300 } },
                stickers: []
            };
        }
        function changeFormat(ratio) {
            if(ratio === '1:1') { config.width = 1080; config.height = 1080; }
            if(ratio === '9:16') { config.width = 1080; config.height = 1920; }
            if(ratio === '16:9') { config.width = 1920; config.height = 1080; }
            document.querySelectorAll('[id^="btn-"]').forEach(b => { b.classList.remove('bg-orange-600', 'text-white'); b.classList.add('text-slate-300', 'hover:bg-slate-700'); });
            document.getElementById(`btn-${ratio.replace(':','-')}`).classList.add('bg-orange-600', 'text-white');
            
            // Set High-DPI canvas size
            canvas.width = config.width * SCALE; 
            canvas.height = config.height * SCALE;
            
            config.slides.forEach(s => { s.textPos.x = config.width/2; s.subPos.x = config.width/2; s.bodyPos.x = config.width/2; s.chart.pos.x = config.width/2; });
            draw();
        }
        function addSlide() {
            const newSlide = createSlide();
            if(config.slides.length > 0) {
                const prev = config.slides[config.slides.length-1];
                newSlide.bgImg = prev.bgImg; newSlide.bgSrc = prev.bgSrc; newSlide.bgPos = {...prev.bgPos};
                newSlide.logos = JSON.parse(JSON.stringify(prev.logos));
                newSlide.logos.forEach((l, i) => { if(prev.logos[i].img) l.img = prev.logos[i].img; });
            }
            config.slides.push(newSlide); selectSlide(config.slides.length - 1); saveState();
        }
        function selectSlide(idx) { config.currentIdx = idx; config.selected = null; renderSlideList(); loadUIFromSlide(); draw(); }
        function deleteSelected() {
            if(!config.selected) return;
            const s = config.slides[config.currentIdx];
            if(config.selected.startsWith('logo-')) {
                const idx = parseInt(config.selected.split('-')[1]);
                s.logos.splice(idx, 1);
            }
            else if (config.selected.startsWith('sticker-')) { 
                const idx = parseInt(config.selected.split('-')[1]); 
                s.stickers.splice(idx, 1); 
            }
            config.selected = null; saveState(); draw();
            document.getElementById('objectControls').classList.add('hidden');
        }
        function loadUIFromSlide() {
            const s = config.slides[config.currentIdx];
            document.getElementById('textInput').value = s.text; document.getElementById('fontSelectMain').value = s.fontMain; document.getElementById('mainColor').value = s.colorMain; document.getElementById('fontSizeSlider').value = s.fontSize;
            document.getElementById('subInput').value = s.sub || ""; document.getElementById('fontSelectSub').value = s.fontSub; document.getElementById('subColor').value = s.colorSub; document.getElementById('subSizeSlider').value = s.subSize || 40;
            document.getElementById('bodyInput').value = s.body || ""; document.getElementById('fontSelectBody').value = s.fontBody; document.getElementById('bodyColor').value = s.colorBody; document.getElementById('bodySizeSlider').value = s.bodySize || 24;
            document.getElementById('showChart').checked = s.chart.visible; document.getElementById('chartType').value = s.chart.type; document.getElementById('chartLabels').value = s.chart.labels; document.getElementById('chartData').value = s.chart.data; document.getElementById('chartColor').value = s.chart.colors; document.getElementById('chartScale').value = s.chart.scale * 100;
            document.getElementById('frameType').value = config.frame.type; document.getElementById('frameScale').value = config.frame.scale * 100; document.getElementById('frameColor').value = config.frame.color;
            document.getElementById('objectControls').classList.add('hidden');
        }
        function updateSlideData() {
            const s = config.slides[config.currentIdx];
            s.text = document.getElementById('textInput').value; s.fontMain = document.getElementById('fontSelectMain').value; s.colorMain = document.getElementById('mainColor').value; s.fontSize = parseInt(document.getElementById('fontSizeSlider').value);
            s.sub = document.getElementById('subInput').value; s.fontSub = document.getElementById('fontSelectSub').value; s.colorSub = document.getElementById('subColor').value; s.subSize = parseInt(document.getElementById('subSizeSlider').value);
            s.body = document.getElementById('bodyInput').value; s.fontBody = document.getElementById('fontSelectBody').value; s.colorBody = document.getElementById('bodyColor').value; s.bodySize = parseInt(document.getElementById('bodySizeSlider').value);
            s.chart.visible = document.getElementById('showChart').checked; s.chart.type = document.getElementById('chartType').value; s.chart.labels = document.getElementById('chartLabels').value; s.chart.data = document.getElementById('chartData').value; s.chart.colors = document.getElementById('chartColor').value; s.chart.scale = document.getElementById('chartScale').value / 100;
            config.frame.type = document.getElementById('frameType').value; config.frame.scale = document.getElementById('frameScale').value / 100; config.frame.color = document.getElementById('frameColor').value;
            draw(); renderSlideList();
        }

        // --- DRAWING ---
        function draw(animState = { textAlpha: 1, bgScale: 1 }) {
            const s = config.slides[config.currentIdx];
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // High-DPI: Save context and scale
            ctx.save();
            ctx.scale(SCALE, SCALE);

            // 1. BG (No more dimming overlay)
            if (s.bgImg) {
                const scale = animState.bgScale;
                const ratio = Math.max(config.width / s.bgImg.width, config.height / s.bgImg.height) * scale;
                let dx = (config.width - s.bgImg.width * ratio) / 2 + s.bgPos.x;
                let dy = (config.height - s.bgImg.height * ratio) / 2 + s.bgPos.y;
                ctx.drawImage(s.bgImg, 0,0, s.bgImg.width, s.bgImg.height, dx, dy, s.bgImg.width*ratio, s.bgImg.height*ratio);
            } else { ctx.fillStyle = s.bgVal; ctx.fillRect(0, 0, config.width, config.height); }
            if (s.chart.visible) drawInfographic(s.chart);
            ctx.globalAlpha = animState.textAlpha;
            drawTextBlock(s.text, s.textPos, s.fontSize, s.fontMain, s.colorMain, 'bold', 'text');
            drawTextBlock(s.sub, s.subPos, s.subSize, s.fontSub, s.colorSub, 'normal', 'sub');
            drawTextBlock(s.body, s.bodyPos, s.bodySize, s.fontBody, s.colorBody, 'normal', 'body', true);
            ctx.globalAlpha = 1;
            
            // 4. Logos
            s.logos.forEach((l, i) => {
                if(l.img) {
                    const w = 150 * l.scale; const h = w * (l.img.height / l.img.width);
                    ctx.drawImage(l.img, l.x - w/2, l.y - h/2, w, h);
                    if(config.selected === `logo-${i}` || config.drag.target === `logo-${i}`) { ctx.strokeStyle = '#ea580c'; ctx.lineWidth = 3; ctx.strokeRect(l.x - w/2 - 2, l.y - h/2 - 2, w + 4, h + 4); }
                }
            });

            // 5. Stickers
            s.stickers.forEach((st, i) => {
                const size = (st.size || 200) * (st.scale || 1); // Use dynamic scale
                ctx.drawImage(st.img, st.x - size/2, st.y - size/2, size, size);
                if(config.selected === `sticker-${i}` || config.drag.target === `sticker-${i}`) { ctx.strokeStyle = '#ea580c'; ctx.lineWidth = 3; ctx.strokeRect(st.x - size/2 - 2, st.y - size/2 - 2, size + 4, size + 4); }
            });
            if(config.effects.grain) applyGrain(); if(config.effects.paper) applyPaper(); if(config.effects.vignette) applyVignette(); if(config.effects.grunge) applyGrunge(); if(config.effects.retro) applyRetro(); if(config.effects.contrast) applyContrast();
            drawFrame();
            if(!config.isRecording) drawGuides();
            
            ctx.restore(); // Restore scale
        }

        function drawFrame() {
            if(config.frame.type === 'none') return;
            const m = config.width * (1 - config.frame.scale) / 2;
            const w = config.width - m*2; const h = config.height - m*2;
            ctx.strokeStyle = config.frame.color; ctx.lineWidth = 15;
            if(config.frame.type === 'simple') { ctx.strokeRect(m, m, w, h); }
            else if(config.frame.type === 'offset') { ctx.strokeRect(m, m, w, h); ctx.lineWidth=5; ctx.strokeRect(m+20, m+20, w-40, h-40); }
            else if(config.frame.type === 'neon') { ctx.shadowColor=config.frame.color; ctx.shadowBlur=30; ctx.lineWidth=10; ctx.strokeRect(m, m, w, h); ctx.shadowBlur=0; }
            else if(config.frame.type === 'corners') {
                const len = 150; ctx.lineWidth=20; ctx.beginPath(); 
                ctx.moveTo(m, m+len); ctx.lineTo(m, m); ctx.lineTo(m+len, m);
                ctx.moveTo(config.width-m-len, m); ctx.lineTo(config.width-m, m); ctx.lineTo(config.width-m, m+len);
                ctx.moveTo(m, config.height-m-len); ctx.lineTo(m, config.height-m); ctx.lineTo(m+len, config.height-m);
                ctx.moveTo(config.width-m-len, config.height-m); ctx.lineTo(config.width-m, config.height-m); ctx.lineTo(config.width-m, config.height-m-len);
                ctx.stroke();
            }
        }
        function drawGuides() { if (config.guides.x !== null) { ctx.beginPath(); ctx.moveTo(config.guides.x, 0); ctx.lineTo(config.guides.x, config.height); ctx.strokeStyle = '#06b6d4'; ctx.lineWidth = 1; ctx.setLineDash([5,5]); ctx.stroke(); ctx.setLineDash([]); } if (config.guides.y !== null) { ctx.beginPath(); ctx.moveTo(0, config.guides.y); ctx.lineTo(config.width, config.guides.y); ctx.strokeStyle = '#06b6d4'; ctx.lineWidth = 1; ctx.setLineDash([5,5]); ctx.stroke(); ctx.setLineDash([]); } }
        function drawTextBlock(txt, pos, size, font, color, weight, id, multiline=false) {
            if(!txt) return; ctx.save(); ctx.font = `${weight} ${size}px "${font}"`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillStyle = color; ctx.shadowColor = 'rgba(0,0,0,0.5)'; ctx.shadowBlur = 10;
            if(multiline) { const lines = txt.split('\n'); const lh = size * 1.4; lines.forEach((l, i) => ctx.fillText(l, pos.x, pos.y + i*lh)); } else { ctx.fillText(txt.toUpperCase(), pos.x, pos.y); }
            if(config.drag.target === id && !config.isRecording) { ctx.strokeStyle = '#ea580c'; ctx.lineWidth = 1; ctx.strokeRect(pos.x - 150, pos.y - size, 300, size*2 + (multiline?50:0)); } ctx.restore();
        }
        function drawInfographic(chart) {
            const vals = chart.data.split(',').map(n => parseFloat(n) || 0); const lbls = chart.labels.split(',').map(s => s.trim()); const color = chart.colors; const cx = chart.pos.x; const cy = chart.pos.y; const scale = chart.scale; ctx.save();
            if (chart.type === 'bar') { const w = 60 * scale; const gap = 20 * scale; const totalW = vals.length * (w + gap); const maxVal = Math.max(...vals, 1); vals.forEach((v, i) => { const h = (v / maxVal) * 300 * scale; const x = cx - totalW/2 + i*(w+gap); const y = cy; ctx.fillStyle = color; ctx.beginPath(); ctx.roundRect(x, y - h, w, h, 5); ctx.fill(); ctx.fillStyle = 'white'; ctx.font = `bold ${16*scale}px Inter`; ctx.textAlign = 'center'; const lblY = (i % 2 === 0) ? y + 25*scale : y + 45*scale; if(lbls[i]) ctx.fillText(lbls[i], x + w/2, lblY); ctx.fillText(v, x + w/2, y - h - 10*scale); }); } 
            else if (chart.type === 'pie') { const r = 150 * scale; const total = vals.reduce((a,b)=>a+b, 0); let angle = -Math.PI/2; vals.forEach((v, i) => { const slice = (v/total) * Math.PI * 2; ctx.beginPath(); ctx.moveTo(cx, cy); ctx.arc(cx, cy, r, angle, angle + slice); ctx.fillStyle = i===0 ? color : `hsl(${220 + i*20}, 60%, 50%)`; ctx.fill(); const mid = angle + slice/2; const labelR = r + 40*scale; const lx = cx + labelR * Math.cos(mid); const ly = cy + labelR * Math.sin(mid); ctx.fillStyle = 'white'; ctx.font = `bold ${14*scale}px Inter`; ctx.textAlign = lx > cx ? 'left' : 'right'; if(lbls[i]) ctx.fillText(`${lbls[i]} (${v})`, lx, ly); angle += slice; }); } 
            else if (chart.type === 'line') { const w = 500 * scale; const h = 300 * scale; const max = Math.max(...vals, 1); const step = w / (vals.length - 1 || 1); const startX = cx - w/2; const startY = cy + h/2; ctx.beginPath(); ctx.strokeStyle = color; ctx.lineWidth = 5 * scale; const points = []; vals.forEach((v, i) => { const px = startX + i*step; const py = startY - (v/max)*h; points.push({x:px, y:py, v, l:lbls[i]}); if(i===0) ctx.moveTo(px, py); else ctx.lineTo(px, py); }); ctx.stroke(); points.forEach(p => { ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(p.x, p.y, 8*scale, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = 'white'; ctx.textAlign = 'center'; ctx.fillText(p.v, p.x, p.y - 15); if(p.l) ctx.fillText(p.l, p.x, startY + 25); }); } 
            else if (chart.type === 'list') { const w = 500 * scale; const rowH = 60 * scale; const startY = cy - (vals.length * rowH)/2; vals.forEach((v, i) => { const y = startY + i * rowH; ctx.fillStyle = 'rgba(255,255,255,0.1)'; ctx.fillRect(cx - w/2, y, w, rowH - 10); const max = Math.max(...vals, 1); ctx.fillStyle = color; ctx.fillRect(cx - w/2, y + rowH - 15, (v/max)*w, 5); ctx.fillStyle = 'white'; ctx.textAlign = 'left'; ctx.font = `bold ${24*scale}px Inter`; if(lbls[i]) ctx.fillText(lbls[i], cx - w/2 + 20, y + rowH/2); ctx.textAlign = 'right'; ctx.fillText(v, cx + w/2 - 20, y + rowH/2); }); }
            if(config.drag.target === 'chart' && !config.isRecording) { ctx.strokeStyle = '#ea580c'; ctx.lineWidth = 1; ctx.strokeRect(cx - 50, cy - 50, 100, 100); }
            ctx.restore();
        }

        // --- Interaction ---
        canvas.onmousedown = (e) => {
            const pos = getMousePos(e); const s = config.slides[config.currentIdx]; let hit = false;
            
            // 1. Stickers
            for(let i=s.stickers.length-1; i>=0; i--) { 
                const st = s.stickers[i]; 
                const size = (st.size || 200) * (st.scale || 1);
                if(dist(pos, st) < size/2) { 
                    config.drag = { active: true, target: `sticker-${i}`, offsetX: pos.x - st.x, offsetY: pos.y - st.y }; 
                    config.selected = `sticker-${i}`; hit = true; 
                    showObjectControls(st.scale || 1);
                    draw(); return; 
                } 
            }
            // 2. Logos
            for(let i=s.logos.length-1; i>=0; i--) {
                const l = s.logos[i];
                if(l.img) {
                    const w = 150 * l.scale;
                    if(dist(pos, l) < w/2) {
                        config.drag = { active: true, target: `logo-${i}`, offsetX: pos.x - l.x, offsetY: pos.y - l.y };
                        config.selected = `logo-${i}`; hit = true;
                        showObjectControls(l.scale);
                        draw(); return;
                    }
                }
            }

            if(!hit) {
                config.selected = null;
                document.getElementById('objectControls').classList.add('hidden');
                if(s.chart.visible && dist(pos, s.chart.pos) < 100) config.drag = { active: true, target: 'chart', offsetX: pos.x - s.chart.pos.x, offsetY: pos.y - s.chart.pos.y };
                else if(dist(pos, s.textPos) < 100) config.drag = { active: true, target: 'text', offsetX: pos.x - s.textPos.x, offsetY: pos.y - s.textPos.y };
                else if(dist(pos, s.subPos) < 50) config.drag = { active: true, target: 'sub', offsetX: pos.x - s.subPos.x, offsetY: pos.y - s.subPos.y };
                else if(dist(pos, s.bodyPos) < 50) config.drag = { active: true, target: 'body', offsetX: pos.x - s.bodyPos.x, offsetY: pos.y - s.bodyPos.y };
                else if(s.bgImg) config.drag = { active: true, target: 'bg', offsetX: pos.x - s.bgPos.x, offsetY: pos.y - s.bgPos.y };
            }
            draw();
        };
        canvas.onmousemove = (e) => {
            if(!config.drag.active) return;
            const pos = getMousePos(e); const s = config.slides[config.currentIdx];
            let x = pos.x - config.drag.offsetX; let y = pos.y - config.drag.offsetY;
            if(config.drag.target !== 'bg') { config.guides = {x:null, y:null}; if(Math.abs(x-config.width/2)<15){x=config.width/2;config.guides.x=x;} if(Math.abs(y-config.height/2)<15){y=config.height/2;config.guides.y=y;} }
            if(config.drag.target === 'text') s.textPos = {x, y}; else if(config.drag.target === 'sub') s.subPos = {x, y}; else if(config.drag.target === 'body') s.bodyPos = {x, y}; else if(config.drag.target === 'chart') s.chart.pos = {x, y}; else if(config.drag.target === 'bg') s.bgPos = {x, y};
            else if(config.drag.target.startsWith('sticker-')) { const idx = parseInt(config.drag.target.split('-')[1]); s.stickers[idx].x = x; s.stickers[idx].y = y; }
            else if(config.drag.target.startsWith('logo-')) { const idx = parseInt(config.drag.target.split('-')[1]); s.logos[idx].x = x; s.logos[idx].y = y; }
            draw();
        };
        window.onmouseup = () => { if(config.drag.active) { config.drag.active = false; config.guides={x:null,y:null}; saveState(); draw(); } };
        function getMousePos(e) { 
            const r = canvas.getBoundingClientRect(); 
            // Calculate mouse position relative to LOGICAL width/height, not scaled
            return { 
                x: (e.clientX - r.left) * (config.width / r.width), 
                y: (e.clientY - r.top) * (config.height / r.height) 
            }; 
        }
        function dist(p1, p2) { return Math.sqrt(Math.pow(p1.x-p2.x, 2) + Math.pow(p1.y-p2.y, 2)); }
        
        function showObjectControls(currentScale) {
            const panel = document.getElementById('objectControls');
            panel.classList.remove('hidden');
            document.getElementById('objectScaleSlider').value = currentScale * 100;
            document.getElementById('objectScaleValue').innerText = Math.round(currentScale * 100) + '%';
        }

        // --- DRAG & DROP SLIDES ---
        function dragStart(e, idx) { e.dataTransfer.setData('text', idx); }
        function dragOver(e) { e.preventDefault(); }
        function drop(e, targetIdx) {
            e.preventDefault();
            const sourceIdx = parseInt(e.dataTransfer.getData('text'));
            if(sourceIdx !== targetIdx) {
                const moved = config.slides[sourceIdx];
                config.slides.splice(sourceIdx, 1);
                config.slides.splice(targetIdx, 0, moved);
                config.currentIdx = targetIdx;
                saveState(); renderSlideList(); loadUIFromSlide(); draw();
            }
        }

        // --- DUPLICATE ---
        function duplicateSlide(idx) {
            const original = config.slides[idx];
            const copy = JSON.parse(JSON.stringify(original, (k,v)=>(k==='bgImg'||k==='img'||k==='stickers'&&v.img)?undefined:v));
            if(original.bgImg) { copy.bgImg = original.bgImg; copy.bgSrc = original.bgSrc; }
            // Deep copy arrays of objects
            if(original.logos) { copy.logos = original.logos.map(l => ({...l, img: l.img})); }
            if(original.stickers) { copy.stickers = original.stickers.map(st => ({...st, img: st.img})); }
            config.slides.splice(idx + 1, 0, copy);
            config.currentIdx = idx + 1;
            saveState(); renderSlideList(); loadUIFromSlide(); draw();
        }

        function renderSlideList() {
             const list = document.getElementById('slideList');
             list.innerHTML = config.slides.map((s, i) => `
                <div draggable="true" ondragstart="dragStart(event, ${i})" ondragover="dragOver(event)" ondrop="drop(event, ${i})" 
                     onclick="selectSlide(${i})" 
                     class="slide-card cursor-pointer p-2 rounded-lg bg-slate-800 relative group ${i === config.currentIdx ? 'active border-orange-500' : 'border-transparent'}">
                    
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[10px] font-bold text-slate-400">–°–õ–ê–ô–î ${i+1}</span>
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="event.stopPropagation(); duplicateSlide(${i})" class="text-slate-400 hover:text-white" title="–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å">
                                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                            </button>
                            <button onclick="event.stopPropagation(); deleteSlide(${i})" class="text-slate-400 hover:text-red-500" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
                        </div>
                    </div>
                    
                    <div class="h-16 bg-slate-700 rounded overflow-hidden relative">
                         ${s.bgImg ? `<img src="${s.bgImg.src}" class="w-full h-full object-cover opacity-50">` : ''}
                         <div class="absolute inset-0 flex items-center justify-center text-[8px] text-white opacity-80 pointer-events-none">${s.text.substring(0,15)}</div>
                    </div>
                </div>
            `).join('');
        }
        
        function deleteSlide(idx) {
            if(config.slides.length <= 1) return;
            config.slides.splice(idx, 1);
            config.currentIdx = Math.max(0, idx - 1);
            saveState(); renderSlideList(); loadUIFromSlide(); draw();
        }

        // --- File Handlers ---
        function handleBgUpload(e) { const f = e.target.files[0]; if(!f)return; const r = new FileReader(); r.onload = (evt) => { const i = new Image(); i.onload = () => { config.slides[config.currentIdx].bgImg = i; config.slides[config.currentIdx].bgSrc = evt.target.result; draw(); renderSlideList(); saveState(); }; i.src = evt.target.result; }; r.readAsDataURL(f); }
        function handleLogoUpload(e) { const f = e.target.files[0]; if(!f)return; const r = new FileReader(); r.onload = (evt) => { const i = new Image(); i.onload = () => { const c = removeWhiteBackground(i); const s = config.slides[config.currentIdx]; s.logos.push({ img: c, src: c.src, x: config.width - 150, y: 150, scale: 1 }); draw(); saveState(); }; i.src = evt.target.result; }; r.readAsDataURL(f); }
        function removeWhiteBackground(img) { const c = document.createElement('canvas'); c.width = img.width; c.height = img.height; const cx = c.getContext('2d'); cx.drawImage(img, 0, 0); const idata = cx.getImageData(0,0,c.width,c.height); const d = idata.data; for(let i=0; i<d.length; i+=4) if(d[i]>240 && d[i+1]>240 && d[i+2]>240) d[i+3] = 0; cx.putImageData(idata, 0, 0); const n = new Image(); n.src = c.toDataURL(); return n; }

        // --- Effects ---
        function toggleEffect(eff) { config.effects[eff] = !config.effects[eff]; updateUIEffects(); draw(); saveState(); }
        function updateUIEffects() { Object.keys(config.effects).forEach(k => { const el = document.getElementById(`eff-${k}`); if(el) { if(config.effects[k]) el.classList.add('active'); else el.classList.remove('active'); }}); }
        function applyGrain() { const id = ctx.getImageData(0,0,canvas.width,canvas.height); const d = id.data; for(let i=0; i<d.length; i+=4) { const n = (Math.random()-0.5)*30; d[i]+=n; d[i+1]+=n; d[i+2]+=n; } ctx.putImageData(id, 0,0); }
        function applyPaper() { ctx.save(); ctx.globalCompositeOperation = 'overlay'; ctx.fillStyle = 'rgba(255,250,240,0.1)'; for(let i=0; i<1000; i++) ctx.fillRect(Math.random()*canvas.width, Math.random()*canvas.height, 2, 2); ctx.restore(); }
        function applyVignette() { const g = ctx.createRadialGradient(canvas.width/2, canvas.height/2, canvas.width/3, canvas.width/2, canvas.height/2, canvas.width); g.addColorStop(0, 'rgba(0,0,0,0)'); g.addColorStop(1, 'rgba(0,0,0,0.6)'); ctx.fillStyle = g; ctx.fillRect(0,0,canvas.width,canvas.height); }
        function applyGrunge() { ctx.save(); ctx.globalCompositeOperation = 'multiply'; ctx.strokeStyle = 'rgba(0,0,0,0.3)'; ctx.lineWidth=2; for(let i=0; i<50; i++) { ctx.beginPath(); ctx.moveTo(Math.random()*canvas.width, Math.random()*canvas.height); ctx.lineTo(Math.random()*canvas.width, Math.random()*canvas.height); ctx.stroke(); } ctx.restore(); }
        function applyRetro() { const id = ctx.getImageData(0,0,canvas.width,canvas.height); const d = id.data; for(let i=0; i<d.length; i+=4) { const r=d[i], g=d[i+1], b=d[i+2]; d[i] = r*0.393 + g*0.769 + b*0.189; d[i+1] = r*0.349 + g*0.686 + b*0.168; d[i+2] = r*0.272 + g*0.534 + b*0.131; } ctx.putImageData(id, 0,0); }
        function applyContrast() { const f = (259 * (30 + 255)) / (255 * (259 - 30)); const id = ctx.getImageData(0,0,canvas.width,canvas.height); const d = id.data; for(let i=0; i<d.length; i+=4) { d[i] = f * (d[i] - 128) + 128; d[i+1] = f * (d[i+1] - 128) + 128; d[i+2] = f * (d[i+2] - 128) + 128; } ctx.putImageData(id, 0,0); }

        // --- Export ---
        function downloadCurrent(fmt) { const link = document.createElement('a'); link.download = `slide.${fmt}`; link.href = canvas.toDataURL(`image/${fmt}`); link.click(); }
        async function exportAllPDF() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF({ unit: 'px', format: [config.width, config.height], orientation: config.width > config.height ? 'l' : 'p' });
            const savedIdx = config.currentIdx;
            for(let i=0; i<config.slides.length; i++) { config.currentIdx = i; draw(); await new Promise(r => setTimeout(r, 50)); const img = canvas.toDataURL('image/jpeg', 0.9); if(i > 0) doc.addPage([config.width, config.height]); doc.addImage(img, 'JPEG', 0, 0, config.width, config.height); }
            config.currentIdx = savedIdx; draw(); doc.save('carousel.pdf');
        }

        async function exportVideo(format) {
            if(config.isRecording) return;
            config.isRecording = true;
            document.getElementById('recordingIndicator').classList.remove('hidden');
            document.getElementById('downloadMenu').classList.remove('show');

            const stream = canvas.captureStream(30);
            let mimeType = 'video/webm;codecs=vp9';
            if (format === 'mp4' && MediaRecorder.isTypeSupported('video/mp4')) {
                mimeType = 'video/mp4';
            }

            const recorder = new MediaRecorder(stream, { mimeType });
            const chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `carousel.${format === 'mp4' ? 'mp4' : 'webm'}`; a.click();
                config.isRecording = false;
                document.getElementById('recordingIndicator').classList.add('hidden');
                config.currentIdx = savedIdx; draw();
            };

            recorder.start();
            const savedIdx = config.currentIdx;
            for (let i = 0; i < config.slides.length; i++) {
                config.currentIdx = i;
                for (let f = 0; f < 60; f++) {
                    const progress = f / 60;
                    const textAlpha = Math.min(1, progress * 2);
                    const bgScale = 1 + (progress * 0.05);
                    draw({ textAlpha, bgScale });
                    await new Promise(r => setTimeout(r, 33));
                }
            }
            recorder.stop();
        }

        // --- STICKER LIBRARY ---
        const stickerLibrary = {
            'emoji': ['üòÄ','üòÇ','ü•∞','üòé','ü§î','üëç','üëé','üî•','‚ú®','üéâ','üöÄ','‚ù§Ô∏è','üíØ','üëÄ','üê∂','üê±'],
            'shape': ['‚ö´','‚ö™','üü•','üü¶','üî∫','‚≠ê','üî∑','üî∂','üõë','‚≠ï'],
            'social': ['üëç','üí¨','üîî','üì¢','üìß','üìû','üåê','üìç']
        };

        function searchStickers() {
            const query = document.getElementById('stickerSearch').value.toLowerCase();
            const resultsDiv = document.getElementById('stickerResults');
            resultsDiv.innerHTML = '';

            let found = [];
            for (const key in stickerLibrary) {
                if(key.includes(query) || query === '') found = found.concat(stickerLibrary[key]);
            }
            if(query.length > 2) {
                found.push(`https://img.icons8.com/color/200/${query}.png`);
                found.push(`https://img.icons8.com/3d-fluency/200/${query}.png`);
                found.push(`https://img.icons8.com/fluency/200/${query}.png`);
                found.push(`https://img.icons8.com/office/200/${query}.png`);
            }

            if(found.length === 0) {
                resultsDiv.innerHTML = '<div class="col-span-4 text-center text-[10px] text-slate-500 mt-4">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                return;
            }

            found.forEach(item => {
                const div = document.createElement('div');
                div.className = 'sticker-item flex items-center justify-center h-12 bg-slate-800 rounded hover:bg-slate-700 cursor-pointer';
                if(item.startsWith('http')) {
                    const img = document.createElement('img');
                    img.src = item;
                    img.className = "max-h-full max-w-full";
                    img.onerror = () => { div.remove(); }; 
                    div.appendChild(img);
                    div.onclick = () => addSticker(item, true);
                } else {
                    div.innerText = item;
                    div.style.fontSize = '24px';
                    div.onclick = () => addSticker(item, false);
                }
                resultsDiv.appendChild(div);
            });
        }

        function quickCategory(cat) {
            document.getElementById('stickerSearch').value = cat;
            searchStickers();
        }

        function addSticker(source, isImage) {
            if(isImage) {
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.src = source;
                img.onload = () => {
                    config.slides[config.currentIdx].stickers.push({
                        img: img,
                        src: source,
                        x: config.width/2,
                        y: config.height/2,
                        scale: 1, // Default scale
                        size: 200 // Default base size
                    });
                    draw(); saveState();
                };
            } else {
                const c = document.createElement('canvas');
                c.width = 200; c.height = 200;
                const x = c.getContext('2d');
                x.font = "150px serif";
                x.textAlign = "center";
                x.textBaseline = "middle";
                x.fillText(source, 100, 110);
                
                const img = new Image();
                img.src = c.toDataURL();
                img.onload = () => {
                    config.slides[config.currentIdx].stickers.push({
                        img: img,
                        src: img.src,
                        x: config.width/2,
                        y: config.height/2,
                        scale: 1,
                        size: 200
                    });
                    draw(); saveState();
                }
            }
        }

        async function generateAIBg() {
            const p = document.getElementById('bgPrompt').value; const btn = document.getElementById('btnBgGen'); 
            const loader = document.getElementById('aiLoader');
            if(!p)return;
            loader.classList.remove('hidden');
            try { const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ instances: [{ prompt: `${p}, abstract background texture, high quality` }] }) }); const d = await r.json(); if(d.predictions) { const i = new Image(); i.src = `data:image/png;base64,${d.predictions[0].bytesBase64Encoded}`; i.onload = () => { config.slides[config.currentIdx].bgImg = i; config.slides[config.currentIdx].bgSrc = i.src; draw(); renderSlideList(); saveState(); }; } } catch(e) { alert('–û—à–∏–±–∫–∞ AI'); } finally { loader.classList.add('hidden'); }
        }
    </script>
</body>
</html>